name: Deploy via Self-Hosted Runner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    # Mudamos de ubuntu-latest para self-hosted
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # Não precisa mais do 'appleboy/ssh-action'. 
      # Rodamos os comandos direto no shell da máquina.
      
      - name: Update and Restart Docker
        run: |
          # Vai para a pasta do projeto (ajuste o caminho se necessário)
          # O runner costuma fazer checkout na pasta _work dentro de actions-runner
          # Mas como você já tem a pasta configurada com .env e volumes, vamos usar a sua pasta original:
          
          cd ~/dbprivateapp
          
          # Atualiza permissões
          sudo chown -R $USER:$USER .
          
          # Atualiza código
          git fetch --all
          git reset --hard origin/main
          
          # Docker
          docker compose down
          docker compose up -d --build
          
          # Banco
          sleep 10
          docker compose exec -T api npx prisma db push
          
          echo "✅ Deploy via Runner concluído!"